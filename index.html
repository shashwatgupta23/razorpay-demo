<!DOCTYPE html>
<html lang="en">
<head>
 <script src="https://applepay.cdn-apple.com/jsapi/v1/apple-pay-sdk.js"></script>
 <meta charset="UTF-8">
 <meta name="viewport" content="width=device-width, initial-scale=1.0">
 <title>Razorpay Payment Integration Demo</title>
 <style>
  * {
    margin: 0;
    padding: 0;
    box-sizing: border-box;
  }

  body {
    font-family: -apple-system, BlinkMacSystemFont, 'SF Pro Display', 'Segoe UI', Roboto, Helvetica, Arial, sans-serif;
    background: #000000;
    min-height: 100vh;
    padding: 60px 20px;
    color: #ffffff;
  }

  .container {
    max-width: 900px;
    margin: 0 auto;
  }

  .header {
    text-align: center;
    margin-bottom: 60px;
  }

  .header h1 {
    font-size: 3rem;
    font-weight: 700;
    letter-spacing: -0.05em;
    margin-bottom: 16px;
    background: linear-gradient(135deg, #ffffff 0%, #a0a0a0 100%);
    -webkit-background-clip: text;
    -webkit-text-fill-color: transparent;
    background-clip: text;
  }

  .header p {
    font-size: 1.125rem;
    color: #86868b;
    font-weight: 400;
    letter-spacing: -0.01em;
  }

  .config-section {
    background: rgba(255, 255, 255, 0.03);
    border: 1px solid rgba(255, 255, 255, 0.1);
    border-radius: 18px;
    padding: 40px;
    margin-bottom: 30px;
    backdrop-filter: blur(20px);
    -webkit-backdrop-filter: blur(20px);
  }

  .config-section h2 {
    font-size: 1.5rem;
    font-weight: 600;
    margin-bottom: 30px;
    color: #f5f5f7;
    letter-spacing: -0.02em;
  }

  .form-row {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 20px;
    margin-bottom: 20px;
  }

  .form-group {
    display: flex;
    flex-direction: column;
  }

  .form-group label {
    font-weight: 500;
    color: #86868b;
    margin-bottom: 10px;
    font-size: 0.875rem;
    letter-spacing: -0.01em;
  }

  .form-group select,
  .form-group input {
    padding: 14px 18px;
    background: rgba(255, 255, 255, 0.05);
    border: 1px solid rgba(255, 255, 255, 0.15);
    border-radius: 12px;
    font-size: 16px;
    color: #ffffff;
    transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    font-family: inherit;
  }

  .form-group select:focus,
  .form-group input:focus {
    outline: none;
    background: rgba(255, 255, 255, 0.08);
    border-color: rgba(255, 255, 255, 0.3);
    box-shadow: 0 0 0 4px rgba(255, 255, 255, 0.05);
  }

  .form-group select option {
    background: #1d1d1f;
    color: #ffffff;
  }

  .payment-section {
    background: rgba(255, 255, 255, 0.03);
    border: 1px solid rgba(255, 255, 255, 0.1);
    border-radius: 18px;
    padding: 40px;
    margin-bottom: 30px;
    backdrop-filter: blur(20px);
    -webkit-backdrop-filter: blur(20px);
  }

  .payment-section h2 {
    font-size: 2rem;
    font-weight: 600;
    margin-bottom: 12px;
    color: #f5f5f7;
    letter-spacing: -0.03em;
  }

  .payment-section .subtitle {
    color: #86868b;
    margin-bottom: 30px;
    font-size: 1rem;
    letter-spacing: -0.01em;
  }

  .section-divider {
    height: 1px;
    background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.1), transparent);
    margin: 40px 0;
  }

  .pay-button {
    width: 100%;
    padding: 16px;
    background: #ffffff;
    color: #000000;
    border: none;
    border-radius: 12px;
    font-size: 1.0625rem;
    font-weight: 500;
    cursor: pointer;
    transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
    letter-spacing: -0.01em;
    font-family: inherit;
  }

  .pay-button:hover:not(:disabled) {
    transform: scale(0.98);
    opacity: 0.9;
  }

  .pay-button:disabled {
    opacity: 0.4;
    cursor: not-allowed;
  }

  apple-pay-button {
    --apple-pay-button-width: 100%;
    --apple-pay-button-height: 52px;
    --apple-pay-button-border-radius: 12px;
    margin-top: 0;
  }

  .card-input {
    width: 100%;
    padding: 14px 18px;
    background: rgba(255, 255, 255, 0.05);
    border: 1px solid rgba(255, 255, 255, 0.15);
    border-radius: 12px;
    font-size: 16px;
    color: #ffffff;
    margin-bottom: 15px;
    transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    font-family: inherit;
  }

  .card-input::placeholder {
    color: #86868b;
  }

  .card-input:focus {
    outline: none;
    background: rgba(255, 255, 255, 0.08);
    border-color: rgba(255, 255, 255, 0.3);
    box-shadow: 0 0 0 4px rgba(255, 255, 255, 0.05);
  }

  .form-row-3 {
    display: grid;
    grid-template-columns: 1fr 1fr 1fr;
    gap: 15px;
    margin-bottom: 15px;
  }

  .status-message {
    padding: 16px 20px;
    border-radius: 12px;
    margin-top: 20px;
    display: none;
    font-size: 0.9375rem;
    letter-spacing: -0.01em;
  }

  .status-message.show {
    display: block;
  }

  .status-message.success {
    background: rgba(52, 199, 89, 0.15);
    color: #32d74b;
    border: 1px solid rgba(52, 199, 89, 0.3);
  }

  .status-message.error {
    background: rgba(255, 69, 58, 0.15);
    color: #ff453a;
    border: 1px solid rgba(255, 69, 58, 0.3);
  }

  .payment-method-section {
    margin-bottom: 35px;
  }

  .payment-method-section h3 {
    font-size: 1.25rem;
    font-weight: 600;
    margin-bottom: 12px;
    color: #f5f5f7;
    letter-spacing: -0.02em;
  }

  .payment-method-section p {
    color: #86868b;
    font-size: 0.9375rem;
    margin-bottom: 20px;
    letter-spacing: -0.01em;
  }

  @media (max-width: 768px) {
    .form-row, .form-row-3 {
      grid-template-columns: 1fr;
    }

    .header h1 {
      font-size: 2.25rem;
    }

    .config-section,
    .payment-section {
      padding: 30px 24px;
    }
  }
 </style>
</head>
<body>
 <div class="container">
  <div class="header">
   <h1>Razorpay Payments</h1>
   <p>Premium payment experience across multiple geographies</p>
  </div>

  <!-- Configuration Section -->
  <div class="config-section">
   <h2>Configuration</h2>
   <div class="form-row">
    <div class="form-group">
     <label for="country">Country / Geography</label>
     <select id="country" onchange="updateCurrency()">
      <option value="MY">Malaysia (MYR)</option>
      <option value="SG">Singapore (SGD)</option>
      <option value="US">USA (USD)</option>
      <option value="IN">India (INR)</option>
     </select>
    </div>
    <div class="form-group">
     <label for="currency">Currency</label>
     <select id="currency">
      <option value="MYR">MYR</option>
      <option value="SGD">SGD</option>
      <option value="USD">USD</option>
      <option value="INR">INR</option>
     </select>
    </div>
   </div>
   <div class="form-row">
    <div class="form-group">
     <label for="amount">Amount (in smallest unit - cents/paise)</label>
     <input type="number" id="amount" value="500" min="1" />
    </div>
    <div class="form-group">
     <label for="display-amount">Display Amount</label>
     <input type="text" id="display-amount" value="5.00 MYR" readonly style="background: rgba(255, 255, 255, 0.03); cursor: not-allowed;" />
    </div>
   </div>
  </div>

  <!-- Standard Checkout Integration -->
  <div class="payment-section">
   <h2>Standard Checkout</h2>
   <p class="subtitle">Razorpay's hosted checkout page with all payment methods</p>
   <button class="pay-button" onclick="initiateCheckout()">
    Pay with Razorpay
   </button>
  </div>

  <div class="section-divider"></div>

  <!-- Server-to-Server Integrations -->
  <div class="payment-section">
   <h2>Server-to-Server Integrations</h2>
   <p class="subtitle">Direct API integrations for advanced use cases</p>

   <!-- Apple Pay S2S -->
   <div class="payment-method-section">
    <h3>Apple Pay</h3>
    <p>Redirects to Razorpay's hosted Apple Pay page</p>
    <apple-pay-button
     id="apple-pay-button"
     buttonstyle="black"
     type="buy"
     locale="en"
     onclick="initiateApplePayS2S()"
     style="display: none;">
    </apple-pay-button>
    <button
     id="apple-pay-fallback"
     class="pay-button"
     onclick="initiateApplePayS2S()"
     style="display: none;">
     Pay with Apple Pay
    </button>
    <div class="status-message" id="applepay-status"></div>
   </div>

   <!-- Card S2S -->
   <div class="payment-method-section">
    <h3>Card Payment</h3>
    <p>Direct card payment with 3DS/OTP authentication</p>
    <form onsubmit="handleCardPayment(event); return false;">
     <input type="text" id="card-number" class="card-input" placeholder="Card Number" maxlength="19" required />
     <input type="text" id="card-holder" class="card-input" placeholder="Card Holder Name" required />
     <div class="form-row-3">
      <input type="text" id="expiry-month" class="card-input" placeholder="MM" maxlength="2" required />
      <input type="text" id="expiry-year" class="card-input" placeholder="YY" maxlength="2" required />
      <input type="text" id="cvv" class="card-input" placeholder="CVV" maxlength="4" required />
     </div>
     <button type="submit" class="pay-button" id="card-button">Pay with Card</button>
    </form>
    <div class="status-message" id="card-status"></div>
   </div>
  </div>
 </div>

 <!-- Razorpay Checkout Script -->
 <script src="https://checkout.razorpay.com/v1/checkout.js"></script>

 <!-- Shield Integration -->
 <script>
  window.RazorpayShield = {
   config: {
    providers: [{ name: "load_razorpay_session", enabled: true }]
   }
  };
 </script>
 <script src="https://checkout.razorpay.com/v1/shield.js"></script>

 <script>
  // Auto-detect API URL based on environment
  const API_URL = window.location.hostname === 'localhost' || window.location.hostname === '127.0.0.1'
    ? 'http://localhost:3000'
    : window.location.origin;
  let razorpaySessionId = null;

  // Razorpay key IDs by country (for Checkout)
  const CHECKOUT_KEYS = {
   'MY': 'rzp_live_fQOafVJoJqscJ6',
   'SG': 'rzp_live_sg_TMe0NITbhAhyPJ',
   'US': 'rzp_live_us_zTra1XQBrgsH7z',
   'IN': 'rzp_live_NzQyvOURi85M5r'
  };

  // Initialize Shield
  (async function initShield() {
   try {
    const country = document.getElementById('country').value;
    razorpaySessionId = await RazorpayShield.loadRazorpaySession(CHECKOUT_KEYS[country]);
    console.log('✅ Shield initialized');
   } catch (error) {
    console.warn('⚠️ Shield init failed:', error);
   }
  })();

  // Update currency when country changes
  function updateCurrency() {
   const country = document.getElementById('country').value;
   const currencyMap = { 'MY': 'MYR', 'SG': 'SGD', 'US': 'USD', 'IN': 'INR' };
   document.getElementById('currency').value = currencyMap[country];
   updateDisplayAmount();
  }

  // Update display amount
  function updateDisplayAmount() {
   const amount = parseInt(document.getElementById('amount').value);
   const currency = document.getElementById('currency').value;
   const displayAmount = (amount / (currency === 'JPY' || currency === 'INR' && amount < 1000 ? 1 : 100)).toFixed(2);
   document.getElementById('display-amount').value = `${displayAmount} ${currency}`;
  }

  document.getElementById('amount').addEventListener('input', updateDisplayAmount);
  document.getElementById('currency').addEventListener('change', updateDisplayAmount);

  // Card number formatting
  document.getElementById('card-number').addEventListener('input', function(e) {
   let value = e.target.value.replace(/\s/g, '');
   e.target.value = value.match(/.{1,4}/g)?.join(' ') || value;
  });

  // Standard Checkout
  function initiateCheckout() {
   const country = document.getElementById('country').value;
   const amount = parseInt(document.getElementById('amount').value);
   const currency = document.getElementById('currency').value;

   const options = {
    key: CHECKOUT_KEYS[country],
    amount: amount,
    currency: currency,
    name: "Coffee Shop",
    description: "Test Payment",
    handler: function(response) {
     alert("✅ Payment Successful!\nPayment ID: " + response.razorpay_payment_id);
    },
    theme: { color: "#667eea" }
   };

   const rzp = new Razorpay(options);
   rzp.open();
  }

  // Apple Pay S2S
  async function initiateApplePayS2S() {
   const country = document.getElementById('country').value;
   const amount = parseInt(document.getElementById('amount').value);
   const currency = document.getElementById('currency').value;
   const status = document.getElementById('applepay-status');

   status.classList.remove('show', 'success', 'error');

   try {
    const response = await fetch(`${API_URL}/api/create-applepay-payment`, {
     method: 'POST',
     headers: { 'Content-Type': 'application/json' },
     body: JSON.stringify({ amount, currency, country, contact: '+60123456789', email: 'test@example.com' })
    });

    const result = await response.json();

    if (response.ok && result.apple_pay_url) {
     window.location.href = result.apple_pay_url;
    } else if (response.ok) {
     status.textContent = `✅ Payment Successful! ID: ${result.id}`;
     status.classList.add('show', 'success');
    } else {
     throw new Error(result.error?.description || 'Payment failed');
    }
   } catch (error) {
    status.textContent = `❌ Error: ${error.message}`;
    status.classList.add('show', 'error');
   }
  }

  // Card S2S
  async function handleCardPayment(event) {
   event.preventDefault();
   const button = document.getElementById('card-button');
   const status = document.getElementById('card-status');

   status.classList.remove('show', 'success', 'error');
   button.disabled = true;
   button.textContent = 'Processing...';

   try {
    const country = document.getElementById('country').value;
    const amount = parseInt(document.getElementById('amount').value);
    const currency = document.getElementById('currency').value;

    const paymentRequest = {
     amount,
     currency,
     country,
     method: 'card',
     contact: '+60123456789',
     email: 'test@example.com',
     card: {
      number: document.getElementById('card-number').value.replace(/\s/g, ''),
      name: document.getElementById('card-holder').value,
      expiry_month: document.getElementById('expiry-month').value.padStart(2, '0'),
      expiry_year: document.getElementById('expiry-year').value,
      cvv: document.getElementById('cvv').value
     },
     authentication: { authentication_channel: 'browser' },
     browser: {
      java_enabled: navigator.javaEnabled(),
      javascript_enabled: true,
      timezone_offset: new Date().getTimezoneOffset(),
      color_depth: screen.colorDepth,
      screen_width: screen.width,
      screen_height: screen.height
     },
     ip: '0.0.0.0',
     referer: window.location.href,
     user_agent: navigator.userAgent
    };

    if (razorpaySessionId) {
     paymentRequest.device_fingerprint = { gateway_session_id: razorpaySessionId };
    }

    const response = await fetch(`${API_URL}/api/create-payment`, {
     method: 'POST',
     headers: { 'Content-Type': 'application/json' },
     body: JSON.stringify(paymentRequest)
    });

    const result = await response.json();

    if (response.ok && result.authentication?.authentication_url) {
     window.open(result.authentication.authentication_url, '_blank');
     status.textContent = `✅ Payment created! Complete OTP authentication. Payment ID: ${result.id}`;
     status.classList.add('show', 'success');
    } else if (response.ok) {
     status.textContent = `✅ Payment Successful! ID: ${result.id}`;
     status.classList.add('show', 'success');
    } else {
     throw new Error(result.error?.description || 'Payment failed');
    }
   } catch (error) {
    status.textContent = `❌ Error: ${error.message}`;
    status.classList.add('show', 'error');
   } finally {
    button.disabled = false;
    button.textContent = 'Pay with Card';
   }
  }

  // Check Apple Pay availability and show appropriate button
  function checkApplePayAvailability() {
   const applePayButton = document.getElementById('apple-pay-button');
   const fallbackButton = document.getElementById('apple-pay-fallback');

   if (window.ApplePaySession && ApplePaySession.canMakePayments()) {
    // Apple Pay available - show native button
    applePayButton.style.display = 'inline-block';
    fallbackButton.style.display = 'none';
    console.log('✅ Apple Pay available');
   } else {
    // Apple Pay not available - show fallback button
    applePayButton.style.display = 'none';
    fallbackButton.style.display = 'block';
    console.log('ℹ️ Apple Pay not available - showing fallback button');
   }
  }

  // Initialize
  updateDisplayAmount();
  checkApplePayAvailability();
 </script>
</body>
</html>
